import fs from 'fs'

process.env["NODE_TLS_REJECT_UNAUTHORIZED"] = 0

const ddfEndpoint = 'https://wfam-zebra.wellsfargo.com/2cds-service/fundProfileData'
const tanums = ['4323','4515','746','3180','4325','948','3721','4123','4654','356','956','3765','4118','4301','416','216','4303','419','119','4138','654','954','3758','154','3725','496','3657','616','4505','716','4102','4680','4316','960','3768','4705','4651','4308','3551','3756','4132','4821','4313','4503','4702','3171','4814','4312','4518','4706','3169','EAD','ERC','ERH','4302','417','3750','517','4652','4314','4519','3723','4703','4685','EOD','4305','429','4701','4148','4304','424','3762','4700','4806','4324','4516','3761','747','667','967','3759','767','663','963','763','4146','4660','1600','1602','3757','4715','1857','1859','1861','1862','4805','3301','3508','3753','4139','4658','84','3181','4691','4335','3321','3533','3703','3123','4659','3018','3538','3612','3118','4665','3323','3535','3704','3138','4662','3002','3539','3606','4140','4823','3327','3542','3705','3143','4822','33','1809','633','3178','32','532','632','3179','3','3527','63','4713','3322','3534','3718','3158','4809','3317','3528','3707','3160','4811','3330','3509','3763','3161','4813','3328','3520','4716','3011','3543','3764','3107','4815','5102','3310','3519','3702','3124','4819','3009','3608','3510','3105','4683','3354','3549','3751','4137','4653','3325','3536','3607','3156','4693','3004','3507','3708','3101','59','559','3767','3165','4689','932','934','935','3145','4656','3005','3540','3102','4812','3017','3541','3769','3170','3006','3547','3709','3104','5101','3355','3552','3727','3168','4664','3365','3557','3773','3173','3364','3772','3556','3172','4808','252','3722','3177','8','450','947','1751','743','3802','3229','3106','3655','3801','478','3502','3656','3183','452','3710','477','792','453','3720','793','454','3803','3311','3521','3700','4117','4684','3356','3553','3770','3166','4682','3174','5100','4340','4585','4727','4695','4341','4586','4728','4696','4330','4523','4718','4332','4525','4720','4333','4526','4721','4334','4580','4722','4331','4524','4719','3780','1753','1755','1756','4714','4690','940','942','943','944','4657','117','366','67','1854','1856','66','4717','1863','1865','1867','1868','4688','3326','3537','3712','3157','4807','3329','3501','88','1848','1850','86','3162','4666','1815','1808','1817','4142','4692','458','460','461','4712','3369','3561','3781','4616','4668','3782','3370','3562','4617','4669','3371','3563','3783','4618','4670','3372','3564','3784','4619','4671','3373','3565','3785','4620','4672','3374','3566','3786','4621','4673','3375','3567','3787','4622','4674','3376','3568','3788','4623','4675','3377','3569','3789','4624','4676','3378','3570','3790','4625','4677','3379','3571','3791','4626','4678','4339','4584','3792','4628','4694','4725','4338','4583','4818','4336','4581','3779','4726','4820','4723','4816','4724','4337','4582','4817','637','4511','737','4143','4667']
const str = ''
/*
for(let tanum of tanums) {
  setTimeout(()=>{
    fetch(`${ddfEndpoint}?taNumber=${tanum}`)
      .then(resp => {
        // resp.json()
        return resp.text()
      })
      .then(data => {
        const jsonStr = data
        const match = jsonStr.match(/".*?" :/g) // Looks for json field names e.g. "TaNumber" :
        const fieldCount = match === null ? 0 : match.length
        console.log(tanum + '\t' + fieldCount)
        if(fieldCount === 0)
          fs.writeFileSync('./output.txt', jsonStr)
      })
  }, 1000)
}
*/

refetch(tanums, 0)

function refetch(arr, index) {
  if (index >= arr.length){
    console.log(str)
    return
  }
  // else
  const tanum = arr[index]
  fetch(`${ddfEndpoint}?taNumber=${tanum}`)
      .then(resp => {
        // resp.json()
        return resp.text()
      })
      .then(data => {
        const jsonStr = data
        const match = jsonStr.match(/".*?" :/g) // Looks for json field names e.g. "TaNumber" :
        const fieldCount = match === null ? 0 : match.length
        console.log(index, tanum + '\t' + fieldCount)
        if(fieldCount === 0) fs.writeFileSync('./output.txt', jsonStr)
        
        setTimeout(()=>{
          refetch(arr, index+1)
        }, 3000)
      })
}